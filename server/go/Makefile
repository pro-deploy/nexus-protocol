.PHONY: build run test clean docker-build docker-run deps migrate

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
GO=go
DOCKER=docker
DOCKER_COMPOSE=docker-compose
BINARY_NAME=nexus-server
VERSION=1.1.0

# –ü—É—Ç–∏
CMD_DIR=./cmd
BUILD_DIR=./build
CONFIG_DIR=./config

all: deps build

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
deps:
	@echo "üì¶ Installing dependencies..."
	$(GO) mod download
	$(GO) mod tidy

# –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
build:
	@echo "üî® Building $(BINARY_NAME)..."
	CGO_ENABLED=0 GOOS=linux GOARCH=amd64 $(GO) build -a -installsuffix cgo -o $(BUILD_DIR)/$(BINARY_NAME) $(CMD_DIR)/main.go


# –ó–∞–ø—É—Å–∫ –≤ development —Ä–µ–∂–∏–º–µ
run:
	@echo "üöÄ Running $(BINARY_NAME)..."
	$(GO) run $(CMD_DIR)/main.go


# –ó–∞–ø—É—Å–∫ —Å Docker Compose
docker-run:
	@echo "üê≥ Starting with Docker Compose..."
	$(DOCKER_COMPOSE) up -d

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose
docker-stop:
	@echo "üõë Stopping Docker Compose..."
	$(DOCKER_COMPOSE) down

# –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
docker-build:
	@echo "üèóÔ∏è Building Docker image..."
	$(DOCKER) build -f docker/Dockerfile -t nexus-protocol/server:$(VERSION) .

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test:
	@echo "üß™ Running tests..."
	$(GO) test -v ./...

# Integration —Ç–µ—Å—Ç—ã
test-integration:
	@echo "üîó Running integration tests..."
	$(GO) test -tags=integration -v ./...

# Benchmarks
bench:
	@echo "‚ö° Running benchmarks..."
	$(GO) test -bench=. -benchmem ./...

# –õ–∏–Ω—Ç–∏–Ω–≥
lint:
	@echo "üîç Running linter..."
	golangci-lint run ./...

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
fmt:
	@echo "üíÖ Formatting code..."
	$(GO) fmt ./...

# –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞
vet:
	@echo "üî¨ Running go vet..."
	$(GO) vet ./...

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo "üßπ Cleaning up..."
	$(GO) clean
	rm -rf $(BUILD_DIR)
	$(DOCKER_COMPOSE) down -v --remove-orphans

# –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
migrate-up:
	@echo "üóÉÔ∏è Running database migrations..."
	# Implement migration logic

migrate-down:
	@echo "‚¨áÔ∏è Rolling back database migrations..."
	# Implement rollback logic

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ (protobuf, etc.)
generate:
	@echo "ü§ñ Generating code..."
	$(GO) generate ./...

# Health check
health:
	@echo "‚ù§Ô∏è Checking health..."
	curl -f http://localhost:8080/health || echo "Health check failed"

# Logs
logs:
	@echo "üìã Showing logs..."
	$(DOCKER_COMPOSE) logs -f nexus-api

# Development setup
dev-setup: deps
	@echo "üöÄ Setting up development environment..."
	# Create config file if not exists
	@if [ ! -f $(CONFIG_DIR)/config.yaml ]; then \
		cp config/config.yaml.example $(CONFIG_DIR)/config.yaml; \
		echo "‚ö†Ô∏è Please update $(CONFIG_DIR)/config.yaml with your settings"; \
	fi

# Start Keycloak only
keycloak:
	@echo "üîê Starting Keycloak..."
	$(DOCKER_COMPOSE) up keycloak -d
	@echo "Keycloak Admin: http://localhost:8081 (admin/admin)"

# Start all services except Keycloak
services:
	@echo "üöÄ Starting services (without Keycloak)..."
	$(DOCKER_COMPOSE) up postgres redis nexus-api -d

# Start everything
all-services: docker-run

# Stop Keycloak
stop-keycloak:
	@echo "üõë Stopping Keycloak..."
	$(DOCKER_COMPOSE) stop keycloak

# View Keycloak logs
logs-keycloak:
	@echo "üìã Keycloak logs..."
	$(DOCKER_COMPOSE) logs -f keycloak

# Production build
prod-build: clean deps fmt vet lint test build

# Help
help:
	@echo "ü§ñ Available commands:"
	@echo "  make deps          - Install dependencies"
	@echo "  make build         - Build the application"
	@echo "  make run           - Run in development mode"
	@echo "  make docker-run    - Run all services with Docker Compose"
	@echo "  make keycloak      - Start Keycloak only"
	@echo "  make services      - Start services without Keycloak"
	@echo "  make docker-stop   - Stop Docker Compose"
	@echo "  make stop-keycloak - Stop Keycloak"
	@echo "  make test          - Run unit tests"
	@echo "  make test-integration - Run integration tests"
	@echo "  make clean         - Clean up build artifacts"
	@echo "  make health        - Check service health"
	@echo "  make logs          - Show all logs"
	@echo "  make logs-keycloak - Show Keycloak logs"
	@echo "  make dev-setup     - Setup development environment"
	@echo "  make prod-build    - Build for production"
	@echo "  make help          - Show this help"

# Default target
.DEFAULT_GOAL := help

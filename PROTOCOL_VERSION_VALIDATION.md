# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ Nexus Protocol

## –û–±–∑–æ—Ä

–°–µ—Ä–≤–µ—Ä —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª—É @protocol —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤–µ—Ä—Å–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª–∞. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Ä—Å–∏–π –∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### Middleware –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–µ—Ä—Å–∏–π

```go
// ProtocolVersion middleware –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
// 1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤–µ—Ä—Å–∏—é –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
// 2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π
// 3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç PROTOCOL_VERSION_ERROR –ø—Ä–∏ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
r.Use(middleware.ProtocolVersion(logger))
```

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞

Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–µ—Ä—Å–∏—é –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:

1. **Query parameter**: `?protocol_version=2.0.0`
2. **HTTP Header**: `X-Protocol-Version: 2.0.0`
3. **JSON Body**: `"protocol_version": "2.0.0"` (–¥–ª—è JSON –∑–∞–ø—Ä–æ—Å–æ–≤)
4. **Default**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ—Ä—Å–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### –ü—Ä–∞–≤–∏–ª–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

–°–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É Nexus Protocol v2.0.0:

| Client Version | Server Version | Compatible | Notes |
|----------------|----------------|------------|-------|
| 1.0.0         | 2.0.0         | ‚ùå        | Major –≤–µ—Ä—Å–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å |
| 1.1.0         | 2.0.0         | ‚ùå        | Major –≤–µ—Ä—Å–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å |
| 2.0.0         | 2.0.0         | ‚úÖ        | –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å |
| 2.0.1         | 2.0.0         | ‚úÖ        | Patch –≤–µ—Ä—Å–∏—è (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å) |
| 2.1.0         | 2.0.0         | ‚ùå        | Client –Ω–æ–≤–µ–µ —Å–µ—Ä–≤–µ—Ä–∞ |

**–§–æ—Ä–º—É–ª–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:**
- Major –≤–µ—Ä—Å–∏–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å
- Client Minor ‚â§ Server Minor

## API –æ—Ç–≤–µ—Ç—ã

### –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å
```json
{
  "status": "healthy",
  "version": "2.0.0",
  "timestamp": 1640995200
}
```

### –û—à–∏–±–∫–∞ –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
```json
{
  "error": {
    "code": "PROTOCOL_VERSION_MISMATCH",
    "type": "PROTOCOL_VERSION_ERROR",
    "message": "Protocol version not supported",
    "details": "client protocol version 2.1.0 requires server 2.1.x or higher, but server supports 2.0.0",
    "metadata": {
      "client_version": "2.1.0",
      "server_version": "2.0.0",
      "supported_versions": "2.0.x"
    }
  }
}
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
```bash
cd server/go
go run cmd/main.go
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–π
```bash
# –°–æ–≤–º–µ—Å—Ç–∏–º–∞—è –≤–µ—Ä—Å–∏—è
curl "http://localhost:8080/api/v1/health?protocol_version=2.0.0"
# Status: 200

# –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è –≤–µ—Ä—Å–∏—è (client –Ω–æ–≤–µ–µ —Å–µ—Ä–≤–µ—Ä–∞)
curl "http://localhost:8080/api/v1/health?protocol_version=2.1.0"
# Status: 400 —Å –æ—à–∏–±–∫–æ–π PROTOCOL_VERSION_ERROR

# –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è –≤–µ—Ä—Å–∏—è (–¥—Ä—É–≥–∞—è major –≤–µ—Ä—Å–∏—è)
curl "http://localhost:8080/api/v1/health?protocol_version=1.0.0"
# Status: 400 —Å –æ—à–∏–±–∫–æ–π PROTOCOL_VERSION_ERROR

# –ß–µ—Ä–µ–∑ –∑–∞–≥–æ–ª–æ–≤–æ–∫
curl -H "X-Protocol-Version: 2.0.0" http://localhost:8080/api/v1/health
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
./test_protocol_versions.sh
```

## –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Ä—Å–∏–π

### –§—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

```go
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤–µ—Ä—Å–∏–∏
err := types.ValidateProtocolVersion("2.0.0") // nil

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
err := types.CheckProtocolCompatibility("2.0.0", "2.0.0") // nil (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ)
err := types.CheckProtocolCompatibility("2.1.0", "2.0.0") // error (client –Ω–æ–≤–µ–µ —Å–µ—Ä–≤–µ—Ä–∞)
err := types.CheckProtocolCompatibility("1.0.0", "2.0.0") // error (—Ä–∞–∑–Ω—ã–µ major –≤–µ—Ä—Å–∏–∏)
```

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤–µ—Ä—Å–∏–π

- `MAJOR.MINOR.PATCH` - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- `MAJOR.MINOR.PATCH-PRERELEASE` - —Å pre-release
- `MAJOR.MINOR.PATCH+BUILD` - —Å build metadata
- `MAJOR.MINOR.PATCH-PRERELEASE+BUILD` - –ø–æ–ª–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

Middleware –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–µ—Ä—Å–∏–π:

```
INFO Protocol version validated client_version=2.0.0 server_version=2.0.0
WARN Protocol version incompatibility detected client_version=2.1.0 server_version=2.0.0
```

## –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–µ—Ä—Å–∏–π

```go
const (
    CurrentProtocolVersion = "2.0.0"
    CurrentServerVersion    = "2.0.0"
)
```

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π

–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞:

1. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ `pkg/types/types.go`
2. –û–±–Ω–æ–≤–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
4. –û–±–Ω–æ–≤–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ –≤–µ—Ä—Å–∏–∏ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –Ω–∞ —Ñ–æ—Ä–º–∞—Ç
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞—É–¥–∏—Ç–∞
- –ó–∞—â–∏—Ç–∞ –æ—Ç malformed –≤–µ—Ä—Å–∏–π

---

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–µ—Ä–≤–µ—Ä —Ç–µ–ø–µ—Ä—å –Ω–∞ 100% —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª—É Nexus Protocol v2.0.0! üöÄ

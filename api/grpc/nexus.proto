// Nexus AI Platform - Context-Aware Templates
// gRPC API для Nexus системы
// Автор: Биркин Максим
// Версия протокола: 2.0.0

syntax = "proto3";

package nexus;
option go_package = "nexus-full-protocol/api/proto";

import "google/protobuf/struct.proto";

// ============================================================================
// Constants
// ============================================================================

// Version версия протокола Nexus
// Формат: MAJOR.MINOR.PATCH (семантическое версионирование)
// MAJOR - несовместимые изменения API
// MINOR - обратно совместимые новые функции
// PATCH - обратно совместимые исправления ошибок

// ============================================================================
// Common Messages
// ============================================================================

// RequestMetadata метаданные запроса (стандартизированные для всех запросов)
message RequestMetadata {
  string request_id = 1;              // Уникальный ID запроса (UUID)
  string protocol_version = 2;        // Версия протокола (например, "2.0.0")
  string client_version = 3;          // Версия клиента (например, "2.0.0")
  string client_id = 4;               // Идентификатор клиента
  string client_type = 5;              // Тип клиента (web, mobile, sdk, etc.)
  int64 timestamp = 6;                // Unix timestamp запроса
  map<string, string> custom_headers = 7; // Кастомные заголовки
}

// ResponseMetadata метаданные ответа
message ResponseMetadata {
  string request_id = 1;               // ID запроса (из RequestMetadata)
  string protocol_version = 2;         // Версия протокола
  string server_version = 3;            // Версия сервера
  int64 timestamp = 4;                 // Unix timestamp ответа
  int32 processing_time_ms = 5;        // Время обработки в миллисекундах

  // Enterprise features v2.0.0
  RateLimitInfo rate_limit_info = 6;   // Информация о rate limiting
  CacheInfo cache_info = 7;            // Информация о кэшировании
  QuotaInfo quota_info = 8;            // Информация о квотах
}

// ErrorDetail детальная информация об ошибке (для gRPC Status)
// Соответствует спецификации Nexus Protocol v2.0.0
// Примечание: В Protocol Buffers используются имена error_code и error_type,
// но при сериализации в JSON они должны соответствовать полям "code" и "type"
// согласно протоколу (см. protocol/ERROR_HANDLING.md)
message ErrorDetail {
  string error_code = 1;               // Код ошибки (UPPER_SNAKE_CASE, например, "VALIDATION_FAILED")
  string error_type = 2;               // Тип ошибки (например, "VALIDATION_ERROR")
  string message = 3;                  // Человеко-читаемое сообщение об ошибке
  string field = 4;                    // Поле, вызвавшее ошибку (для валидационных ошибок)
  string details = 5;                  // Детальная информация об ошибке
  map<string, string> metadata = 6;    // Дополнительные метаданные ошибки
}

message Location {
  double latitude = 1;
  double longitude = 2;
  double accuracy = 3;
}

message UserContext {
  string user_id = 1;
  string session_id = 2;
  string tenant_id = 3;
  repeated string roles = 4;
  Location location = 5;
  string locale = 6;      // Локаль пользователя (ru-RU, en-US)
  string timezone = 7;    // Часовой пояс (Europe/Moscow)
  string currency = 8;    // Валюта (RUB, USD, EUR)
  string region = 9;      // Регион (RU, US, EU)
}

message Action {
  string type = 1;
  string label = 2;
  string url = 3;
  string method = 4;
  string confirm_text = 5;
}

message ResultItem {
  string id = 1;
  string type = 2;
  string title = 3;
  string description = 4;
  google.protobuf.Struct data = 5;  // Структурированные данные результата (может содержать сложные объекты: stores, addresses и т.д.)
  float relevance = 6;
  float confidence = 7;
  repeated Action actions = 8;
}

message DomainSection {
  string domain_id = 1;
  string title = 2;
  string status = 3;
  string error = 4;
  int32 response_time_ms = 5;
  repeated ResultItem results = 6;
}

message SearchResult {
  string title = 1;
  string url = 2;
  string snippet = 3;
  float relevance = 4;
}

message WebSearchResult {
  repeated SearchResult results = 1;
  string search_engine = 2;
  int32 total_results = 3;
}

message RankedItem {
  string id = 1;
  float score = 2;
  int32 rank = 3;
}

message RankingResult {
  repeated RankedItem items = 1;
  string algorithm = 2;
}

message ExecutionMetadata {
  int64 started_at = 1;
  int64 completed_at = 2;
  int64 total_time_ms = 3;
  map<string, int32> domain_stats = 4;
  int32 domains_executed = 5;
  int32 results_count = 6;
}

message ExecuteOptions {
  int32 timeout_ms = 1;
  int32 max_results_per_domain = 2;
  bool parallel_execution = 3;
  bool include_web_search = 4;
}

// AdvancedFilters содержит расширенные фильтры результатов (Enterprise v2.0.0)
message AdvancedFilters {
  repeated string domains = 1;           // Список доменов для включения
  repeated string exclude_domains = 2;   // Список доменов для исключения
  float min_relevance = 3;               // Минимальная релевантность (0-1)
  int32 max_results = 4;                 // Максимальное количество результатов
  string sort_by = 5;                    // Сортировка: relevance, date, rating
  DateRange date_range = 6;               // Диапазон дат
}

// DateRange представляет диапазон дат
message DateRange {
  int64 from = 1;  // Timestamp начала (Unix timestamp в секундах)
  int64 to = 2;    // Timestamp конца (Unix timestamp в секундах)
}

// Enterprise features v2.0.0 - Monitoring & Metrics
message RateLimitInfo {
  int32 limit = 1;                     // Лимит запросов
  int32 remaining = 2;                 // Оставшиеся запросы
  int64 reset_at = 3;                  // Время сброса лимита (Unix timestamp)
}

message CacheInfo {
  bool cache_hit = 1;                  // Было ли попадание в кэш
  string cache_key = 2;                 // Ключ кэширования
  int32 cache_ttl = 3;                  // TTL кэша в секундах
}

message QuotaInfo {
  int64 quota_used = 1;                // Использовано квоты
  int64 quota_limit = 2;                // Лимит квоты
  string quota_type = 3;                // Тип квоты (requests, data, storage, bandwidth)
}

// Batch Operations v2.0.0
message BatchRequest {
  string batch_id = 1;                 // Уникальный ID батча
  repeated ExecuteTemplateRequest requests = 2; // Запросы в батче
  ExecuteOptions batch_options = 3;    // Общие опции для батча
  RequestMetadata metadata = 4;        // Метаданные запроса
}

message BatchResponse {
  string batch_id = 1;                 // ID батча
  repeated ExecuteTemplateResponse responses = 2; // Ответы
  BatchMetadata batch_metadata = 3;    // Метаданные батча
  ResponseMetadata response_metadata = 4; // Метаданные ответа
}

message BatchMetadata {
  int32 total_requests = 1;            // Общее количество запросов
  int32 successful_requests = 2;       // Успешные запросы
  int32 failed_requests = 3;           // Неудачные запросы
  int64 started_at = 4;                // Время начала
  int64 completed_at = 5;              // Время завершения
  int32 total_processing_time_ms = 6;  // Общее время обработки
}

// Webhook Integration v2.0.0
message WebhookConfig {
  string url = 1;                      // Webhook URL
  repeated string events = 2;          // События для отправки
  map<string, string> headers = 3;     // Дополнительные заголовки
  string secret = 4;                   // Secret для подписи
}

message WebhookDelivery {
  string webhook_id = 1;               // ID webhook'а
  string event_type = 2;               // Тип события
  string payload = 3;                  // JSON payload
  string signature = 4;                // HMAC подпись
  int64 delivered_at = 5;              // Время доставки
  int32 status_code = 6;               // HTTP статус код ответа
  string response_body = 7;            // Тело ответа
}

// ============================================================================
// Context-Aware Templates Service
// ============================================================================

message ExecuteTemplateRequest {
  string query = 1;
  string language = 2;
  UserContext context = 3;
  ExecuteOptions options = 4;
  RequestMetadata metadata = 5;        // Метаданные запроса (опционально)
  AdvancedFilters filters = 6;        // Расширенные фильтры (Enterprise v2.0.0)
}

message ExecuteTemplateResponse {
  string execution_id = 1;
  string intent_id = 2;
  string status = 3;
  string query_type = 4;
  repeated DomainSection sections = 5;
  WebSearchResult web_search = 6;
  RankingResult ranking = 7;
  ExecutionMetadata metadata = 8;
  int32 processing_time_ms = 9;
  ResponseMetadata response_metadata = 10; // Метаданные ответа
}

message GetExecutionStatusRequest {
  string execution_id = 1;
  RequestMetadata metadata = 2;        // Метаданные запроса (опционально)
}

message StreamTemplateRequest {
  string execution_id = 1;
  RequestMetadata metadata = 2;        // Метаданные запроса (опционально)
}

message TemplateResult {
  string execution_id = 1;
  string domain_id = 2;
  DomainSection section = 3;
}

service ContextAwareTemplates {
  rpc ExecuteTemplate(ExecuteTemplateRequest) returns (ExecuteTemplateResponse);
  rpc GetExecutionStatus(GetExecutionStatusRequest) returns (ExecuteTemplateResponse);
  rpc StreamTemplateResults(StreamTemplateRequest) returns (stream TemplateResult);
}

// Enterprise Batch Operations Service v2.0.0
service BatchOperations {
  rpc ExecuteBatch(BatchRequest) returns (BatchResponse);
  rpc GetBatchStatus(GetExecutionStatusRequest) returns (BatchResponse);
}

// Enterprise Webhook Service v2.0.0
service WebhookService {
  rpc RegisterWebhook(WebhookConfig) returns (WebhookConfig);
  rpc UnregisterWebhook(WebhookConfig) returns (Empty);
  rpc ListWebhooks(Empty) returns (WebhookList);
  rpc GetWebhookDeliveries(WebhookConfig) returns (WebhookDeliveryList);
}

message Empty {}

message WebhookList {
  repeated WebhookConfig webhooks = 1;
}

message WebhookDeliveryList {
  string webhook_id = 1;
  repeated WebhookDelivery deliveries = 2;
}

// ============================================================================
// IAM Service
// ============================================================================

message RegisterUserRequest {
  string email = 1;
  string password = 2;
  string first_name = 3;
  string last_name = 4;
  string tenant_id = 5;
}

message RegisterUserResponse {
  bool success = 1;
  string user_id = 2;
  string message = 3;
  string error = 4;
}

message AuthenticateUserRequest {
  string email = 1;
  string password = 2;
}

message AuthenticateUserResponse {
  bool success = 1;
  string access_token = 2;
  string refresh_token = 3;
  int32 expires_in = 4;
  UserProfile user = 5;
  string error = 6;
}

message UserProfile {
  string id = 1;
  string email = 2;
  string username = 3;
  string first_name = 4;
  string last_name = 5;
  string status = 6;
  repeated string roles = 7;
  int64 created_at = 8;
  int64 last_login_at = 9;
}

message GetUserProfileRequest {
  string user_id = 1;
}

message GetUserProfileResponse {
  UserProfile user = 1;
  string error = 2;
}

message UpdateUserProfileRequest {
  string user_id = 1;
  string first_name = 2;
  string last_name = 3;
  string bio = 4;
}

message UpdateUserProfileResponse {
  bool success = 1;
  string message = 2;
  string error = 3;
}

service IAM {
  rpc RegisterUser(RegisterUserRequest) returns (RegisterUserResponse);
  rpc AuthenticateUser(AuthenticateUserRequest) returns (AuthenticateUserResponse);
  rpc GetUserProfile(GetUserProfileRequest) returns (GetUserProfileResponse);
  rpc UpdateUserProfile(UpdateUserProfileRequest) returns (UpdateUserProfileResponse);
}

// ============================================================================
// Placeholder Services (for future implementation)
// ============================================================================

// Commerce service placeholder
service Commerce {}

// Knowledge service placeholder
service Knowledge {}
